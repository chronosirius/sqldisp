<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Expanded View - {{ table_name }}</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #f4f4f4;
            color: #333;
            display: flex;
        }
        .sidebar {
            width: 200px;
            background-color: #333;
            color: white;
            padding: 20px;
            height: 100vh;
            box-sizing: border-box;
            position: fixed;
            overflow: auto;
        }
        .sidebar h2 {
            text-align: center;
            margin-top: 0;
            border-bottom: 1px solid #555;
            padding-bottom: 10px;
        }
        .sidebar ul {
            list-style-type: none;
            padding: 0;
        }
        .sidebar li {
            margin-bottom: 10px;
        }
        .sidebar a {
            display: block;
            color: white;
            text-decoration: none;
            padding: 10px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .sidebar a:hover {
            background-color: #555;
        }
        .content {
            margin-left: 200px;
            flex-grow: 1;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            background: #fff;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #555;
            text-align: center;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
        }
        .form-container {
            margin-top: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .form-container h2 {
            margin-top: 0;
            margin-bottom: 20px;
        }
        .form-container form {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: flex-end;
        }
        .form-container .form-group {
            flex-grow: 1;
        }
        .form-container .form-group input,
        .form-container .form-group select {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .form-container .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-container button {
            padding: 8px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .related-section {
            margin-top: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .junction-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .junction-table th,
        .junction-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .junction-table th {
            background-color: #f5f5f5;
            font-weight: bold;
        }
        .junction-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .junction-form {
            background-color: #fff;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 15px;
        }
        .junction-form h4 {
            margin-top: 0;
            color: #333;
        }
        .junction-form .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: flex-end;
        }
        .junction-form .form-group {
            flex: 1;
        }
        .junction-form .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            font-weight: bold;
        }
        .junction-form .form-group input,
        .junction-form .form-group select {
            width: 100%;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .junction-form button {
            padding: 6px 12px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            white-space: nowrap;
        }
        .related-item {
            display: flex;
            align-items: center;
            background-color: #eee;
            padding: 8px;
            border-radius: 4px;
            margin: 5px 0;
        }
        .related-item button {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
            padding: 4px 8px;
        }
        .related-link {
            color: #007bff;
            text-decoration: none;
            font-weight: bold;
        }
        .related-link:hover {
            text-decoration: underline;
        }
        .contributor-section {
            margin-top: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #e8f5e8;
        }
        .contributor-info {
            background-color: #d1edff;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .contributor-list {
            margin: 15px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .add-contributor-form {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 15px;
        }
        .add-contributor-form input {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .add-contributor-form button {
            padding: 8px 15px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .fk-search-container {
            position: relative;
            margin-top: 5px;
        }
        .fk-search-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .fk-search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        .fk-search-result {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .fk-search-result:hover {
            background-color: #f5f5f5;
        }
        .fk-search-result:last-child {
            border-bottom: none;
        }
        .fk-selected-display {
            margin-top: 5px;
            padding: 8px;
            background-color: #e8f5e8;
            border-radius: 4px;
            font-size: 12px;
            color: #555;
            cursor: pointer;
            display: none;
        }
        .fk-selected-display:hover {
            background-color: #d4edda;
        }
        .action-btn {
            padding: 4px 8px;
            margin: 2px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            color: white;
            font-size: 11px;
        }
        .edit-btn { background-color: #007bff; }
        .delete-btn { background-color: #dc3545; }
        .save-btn { background-color: #28a745; }
        .cancel-btn { background-color: #6c757d; }
        .editable-row { background-color: #fff3cd; }
        .junction-verification {
            position: relative;
        }
        .verification-status {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
            pointer-events: none;
        }
        .verification-info {
            margin-top: 5px;
            font-size: 12px;
            color: #666;
            min-height: 18px;
        }
        /* Junction FK search specific styles */
        .junction-fk-search-container {
            position: relative;
            margin-top: 5px;
        }
        .junction-fk-search-input {
            width: 100%;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 12px;
        }
        .junction-fk-search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        .junction-fk-search-result {
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 12px;
        }
        .junction-fk-search-result:hover {
            background-color: #f5f5f5;
        }
        .junction-fk-search-result:last-child {
            border-bottom: none;
        }
        .junction-fk-selected-display {
            margin-top: 5px;
            padding: 6px;
            background-color: #e8f5e8;
            border-radius: 4px;
            font-size: 11px;
            color: #555;
            cursor: pointer;
            display: none;
        }
        .junction-fk-selected-display:hover {
            background-color: #d4edda;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>Tables</h2>
        <ul>
            {% for table in tables %}
            <li>
                <a href="{{ url_for('dbview.index', table_name=table) }}">
                    {{ table | capitalize }}
                </a>
            </li>
            {% endfor %}
        </ul>
    </div>

    <div class="content">
        <div class="container">
            <h1>Expanded View: {{ table_name }} - 
                {% if primary_key is string %}
                    {{ row_data[primary_key] }}
                {% else %}
                    {% for pk_col in primary_key %}{{ row_data[pk_col] }}{% if not loop.last %}/{% endif %}{% endfor %}
                {% endif %}
            </h1>
            <a href="{{ url_for('dbview.index', table_name=table_name) }}">← Back to Table</a>

            {% if error %}
            <div class="error">
                <p>{{ error }}</p>
            </div>
            {% endif %}

            <div class="form-container">
                <h2>Update {{ table_name }}</h2>
                <form action="{{ url_for('dbmod.row.update_row', table_name=table_name) }}" method="post">
                    {% for col in schema.keys() %}
                    <div class="form-group">
                        <label for="update_{{ col }}">{{ col }}:</label>
                        {% if schema[col]['is_enum'] %}
                        <select id="update_{{ col }}" name="{{ col }}" {% if schema[col]['is_read_only'] %}disabled{% endif %}>
                            {% for value in schema[col]['enum_values'] %}
                            <option value="{{ value }}" {% if row_data[col] == value %}selected{% endif %}>{{ value }}</option>
                            {% endfor %}
                        </select>
                        {% else %}
                        <input type="{{ schema[col]['html_input_type'] }}" id="update_{{ col }}" name="{{ col }}" 
                               value="{{ row_data[col] if row_data[col] is not none else '' }}" 
                               {% if schema[col]['is_read_only'] %}readonly{% endif %}>
                        {% endif %}
                        
                        <!-- Add foreign key search if this column is a foreign key -->
                        {% if schema[col].get('is_foreign_key') %}
                        <div class="fk-search-container">
                            <input type="text" 
                                   class="fk-search-input" 
                                   placeholder="Search {{ schema[col]['foreign_table'] }}..."
                                   data-target-input="update_{{ col }}"
                                   data-table="{{ schema[col]['foreign_table'] }}"
                                   data-search-columns="{{ schema[col]['search_columns']|join(',') }}"
                                   data-display-columns="{{ schema[col]['display_columns']|join(',') }}"
                                   data-foreign-key="{{ schema[col]['foreign_key'] }}">
                            <div class="fk-search-results"></div>
                            <div class="fk-selected-display" onclick="showForeignKeySearch(this)">
                                Click to search or change selection
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                    <button type="submit">Update Row</button>
                </form>
            </div>

            {% if write_only_config %}
            <div class="contributor-section">
                <h2>Contributors & Sharing</h2>
                
                <div class="contributor-info">
                    <strong>Current Contributors:</strong>
                    <div class="contributor-list">
                        {% if row_data[write_only_config['contributor_column']] %}
                            {% set contributors = row_data[write_only_config['contributor_column']].split(',') %}
                            {% set current_user = session['db_user'] %}
                            {% set is_first_contributor = contributors|first|trim == current_user %}
                            {% for contributor in contributors %}
                                <span style="display: inline-flex; align-items: center; background-color: {% if loop.first %}#28a745{% else %}#007bff{% endif %}; color: white; padding: 4px 8px; margin: 2px; border-radius: 4px;">
                                    {{ contributor.strip() }}
                                    {% if loop.first %}
                                        <small style="margin-left: 5px;">(Owner)</small>
                                    {% endif %}
                                    {% if is_first_contributor and not loop.first %}
                                        <form action="{{ url_for('dbmod.contrib.remove_contributor', table_name=table_name) }}" method="post" style="display: inline; margin-left: 5px;">
                                            {% if primary_key is string %}
                                                <input type="hidden" name="{{ primary_key }}" value="{{ row_data[primary_key] }}">
                                            {% else %}
                                                {% for pk_col in primary_key %}
                                                    <input type="hidden" name="{{ pk_col }}" value="{{ row_data[pk_col] }}">
                                                {% endfor %}
                                            {% endif %}
                                            <input type="hidden" name="contributor_to_remove" value="{{ contributor.strip() }}">
                                            <button type="submit" style="background: none; border: none; color: white; cursor: pointer; font-size: 12px; padding: 0;" onclick="return confirm('Remove {{ contributor.strip() }} as contributor?')">×</button>
                                        </form>
                                    {% endif %}
                                </span>
                            {% endfor %}
                        {% else %}
                            <em>No contributors listed</em>
                        {% endif %}
                    </div>
                </div>

                <h3>Add New Contributor</h3>
                <p><em>Note: Only the first contributor (owner) can add or remove other contributors.</em></p>
                {% if row_data[write_only_config['contributor_column']] %}
                    {% set contributors = row_data[write_only_config['contributor_column']].split(',') %}
                    {% set current_user = session['db_user'] %}
                    {% set is_first_contributor = contributors|first|trim == current_user %}
                    {% if is_first_contributor %}
                        <form action="{{ url_for('dbmod.contrib.add_contributor', table_name=table_name) }}" method="post" class="add-contributor-form">
                            {% if primary_key is string %}
                                <input type="hidden" name="{{ primary_key }}" value="{{ row_data[primary_key] }}">
                            {% else %}
                                {% for pk_col in primary_key %}
                                    <input type="hidden" name="{{ pk_col }}" value="{{ row_data[pk_col] }}">
                                {% endfor %}
                            {% endif %}
                            <input type="text" name="new_contributor" placeholder="Enter username to add" required>
                            <button type="submit">Add Contributor</button>
                        </form>
                    {% else %}
                        <p style="color: #666; font-style: italic;">Only the owner ({{ contributors|first|trim }}) can add new contributors.</p>
                    {% endif %}
                {% else %}
                    <form action="{{ url_for('dbmod.contrib.add_contributor', table_name=table_name) }}" method="post" class="add-contributor-form">
                        {% if primary_key is string %}
                            <input type="hidden" name="{{ primary_key }}" value="{{ row_data[primary_key] }}">
                        {% else %}
                            {% for pk_col in primary_key %}
                                <input type="hidden" name="{{ pk_col }}" value="{{ row_data[pk_col] }}">
                            {% endfor %}
                        {% endif %}
                        <input type="text" name="new_contributor" placeholder="Enter username to add" required>
                        <button type="submit">Add Contributor</button>
                    </form>
                {% endif %}
            </div>
            {% endif %}

            {% for junction_data in all_junction_data %}
            <div class="related-section">
                <h2>{{ junction_data.relationship_name | capitalize }}</h2>

                {% if junction_data.config.get('show_multiple_rows', False) %}
                    <!-- Show full junction table with extra columns -->
                    {% if junction_data.rows %}
                    <table class="junction-table">
                        <thead>
                            <tr>
                                {% set config = junction_data.config %}
                                <th>{{ config.other_display_column | capitalize }}</th>
                                {% for col in config.get('extra_columns', []) %}
                                <th>{{ col | capitalize }}</th>
                                {% endfor %}
                                {% if config.other_table == table_name %}
                                <th>Details</th>
                                {% endif %}
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in junction_data.rows %}
                            <tr id="junction-row-{{ loop.index }}">
                                <td>
                                    {% if config.other_table == table_name %}
                                        <a href="{{ url_for('dbview.expanded_view', table_name=config.other_table, row_id=row.other_pk) }}" class="related-link">
                                            {{ row.other_display }}
                                        </a>
                                    {% else %}
                                        {{ row.other_display }}
                                    {% endif %}
                                </td>
                                {% for col in config.get('extra_columns', []) %}
                                <td>
                                    <span class="display-value">{{ row[col] if row[col] is not none else '' }}</span>
                                    <input type="text" class="edit-value" style="display: none; width: 100%;" value="{{ row[col] if row[col] is not none else '' }}">
                                </td>
                                {% endfor %}
                                {% if config.other_table == table_name %}
                                <td style="font-size: 12px; color: #666;">
                                    {% for key, value in row.items() %}
                                        {% if key.startswith('other_') and key != 'other_pk' %}
                                            {{ key.replace('other_', '') }}: {{ value }}<br>
                                        {% endif %}
                                    {% endfor %}
                                </td>
                                {% endif %}
                                <td>
                                    <button class="action-btn edit-btn" onclick="editJunctionRow({{ loop.index }}, '{{ junction_data.relationship_name }}')">Edit</button>
                                    <button class="action-btn save-btn" style="display: none;" onclick="saveJunctionRow({{ loop.index }}, '{{ junction_data.relationship_name }}')">Save</button>
                                    <button class="action-btn cancel-btn" style="display: none;" onclick="cancelJunctionEdit({{ loop.index }})">Cancel</button>
                                    
                                    <form action="{{ url_for('dbmod.jct.remove_junction_entry', table_name=table_name) }}" method="post" style="display:inline;">
                                        <input type="hidden" name="junction_name" value="{{ junction_data.relationship_name }}">
                                        {% if primary_key is string %}
                                            <input type="hidden" name="{{ config.fk_self }}" value="{{ row_data[primary_key] }}">
                                        {% else %}
                                            <input type="hidden" name="{{ config.fk_self }}" value="{{ row_data[primary_key[0]] }}">
                                        {% endif %}
                                        {% for pk_col in config.get('junction_primary_key', [config.fk_self, config.fk_other]) %}
                                        <input type="hidden" name="{{ pk_col }}" value="{{ row[pk_col] }}">
                                        {% endfor %}
                                        <button class="action-btn delete-btn" type="submit" onclick="return confirm('Remove this relationship?')">Delete</button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p>No relationships found.</p>
                    {% endif %}
                {% else %}
                    <!-- Original simple list view -->
                    {% for item in junction_data.rows %}
                    <div class="related-item">
                        <span>{{ item[junction_data.config.other_display_column] }}</span>
                        <form action="{{ url_for('dbmod.jct.remove_junction_entry', table_name=table_name) }}" method="post" style="display:inline;">
                            <input type="hidden" name="junction_name" value="{{ junction_data.relationship_name }}">
                            {% if primary_key is string %}
                                <input type="hidden" name="{{ junction_data.config.fk_self }}" value="{{ row_data[primary_key] }}">
                            {% else %}
                                <input type="hidden" name="{{ junction_data.config.fk_self }}" value="{{ row_data[primary_key[0]] }}">
                            {% endif %}
                            <input type="hidden" name="{{ junction_data.config.fk_other }}" value="{{ item.values() | list | first }}">
                            <button type="submit" onclick="return confirm('Remove this relationship?')">Remove</button>
                        </form>
                    </div>
                    {% endfor %}
                {% endif %}

                <div class="junction-form">
                    <h4>Add New {{ junction_data.relationship_name | capitalize }}</h4>
                    <form action="{{ url_for('dbmod.jct.add_junction_entry', table_name=table_name) }}" method="post">
                        <input type="hidden" name="junction_name" value="{{ junction_data.relationship_name }}">
                        {% if primary_key is string %}
                            <input type="hidden" name="{{ junction_data.config.fk_self }}" value="{{ row_data[primary_key] }}">
                        {% else %}
                            <input type="hidden" name="{{ junction_data.config.fk_self }}" value="{{ row_data[primary_key[0]] }}">
                        {% endif %}
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="junction-{{ junction_data.relationship_name }}-id">{{ junction_data.config.other_table | capitalize }} ID:</label>
                                <input type="text" 
                                       name="{{ junction_data.config.fk_other }}" 
                                       id="junction-{{ junction_data.relationship_name }}-id"
                                       placeholder="Enter {{ junction_data.config.other_table }} ID" 
                                       required>
                                
                                <!-- Add FK search for junction table -->
                                <div class="junction-fk-search-container">
                                    <input type="text" 
                                           class="junction-fk-search-input" 
                                           placeholder="Search {{ junction_data.config.other_table }}..."
                                           data-target-input="junction-{{ junction_data.relationship_name }}-id"
                                           data-table="{{ junction_data.config.other_table }}"
                                           data-junction-name="{{ junction_data.relationship_name }}"
                                           data-main-id="{% if primary_key is string %}{{ row_data[primary_key] }}{% else %}{{ row_data[primary_key[0]] }}{% endif %}"
                                           data-search-columns="{{ junction_data.config.get('search_columns', ['name', 'title', 'description'])|join(',') }}"
                                           data-display-columns="{{ junction_data.config.get('display_columns', ['name', 'title', 'description'])|join(',') }}">
                                    <div class="junction-fk-search-results"></div>
                                    <div class="junction-fk-selected-display" onclick="showJunctionForeignKeySearch(this)">
                                        Click to search for {{ junction_data.config.other_table }}
                                    </div>
                                </div>
                            </div>
                            
                            {% for col in junction_data.config.get('extra_columns', []) %}
                            <div class="form-group">
                                <label for="extra-{{ junction_data.relationship_name }}-{{ col }}">{{ col | capitalize }}:</label>
                                {% if junction_data.junction_schema[col]['is_enum'] %}
                                <select name="extra_{{ col }}" id="extra-{{ junction_data.relationship_name }}-{{ col }}">
                                    <option value="">-- Select {{ col }} --</option>
                                    {% for value in junction_data.junction_schema[col]['enum_values'] %}
                                    <option value="{{ value }}">{{ value }}</option>
                                    {% endfor %}
                                </select>
                                {% else %}
                                <input type="{{ junction_data.junction_schema[col]['html_input_type'] }}" 
                                       name="extra_{{ col }}" 
                                       id="extra-{{ junction_data.relationship_name }}-{{ col }}"
                                       placeholder="{{ col | capitalize }}">
                                {% endif %}
                            </div>
                            {% endfor %}
                            
                            <button type="submit" 
                                    id="add-junction-{{ junction_data.relationship_name }}-btn" 
                                    disabled>
                                Add {{ junction_data.relationship_name | capitalize }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            {% endfor %}

        </div>
    </div>

    <script>
        // Foreign Key Search functionality
        let fkSearchTimeouts = {};
        let junctionFkSearchTimeouts = {};
        
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize foreign key search inputs
            document.querySelectorAll('.fk-search-input').forEach(input => {
                const targetInput = document.getElementById(input.dataset.targetInput);
                const selectedDisplay = input.parentElement.querySelector('.fk-selected-display');
                
                // Load current selection if exists
                if (targetInput.value) {
                    loadForeignKeyDisplay(input, targetInput.value);
                }
                
                input.addEventListener('input', function() {
                    handleForeignKeySearch(this);
                });
                
                input.addEventListener('focus', function() {
                    if (this.value.length >= 1) {
                        handleForeignKeySearch(this);
                    }
                });
                
                input.addEventListener('blur', function() {
                    // Delay hiding results to allow clicks
                    setTimeout(() => {
                        const results = this.parentElement.querySelector('.junction-fk-search-results');
                        results.style.display = 'none';
                    }, 200);
                });
            });

            // Add change listeners to FK input fields to update display
            document.querySelectorAll('input[type="text"], input[type="number"]').forEach(input => {
                // Check if this input has a corresponding FK search
                const fkSearch = document.querySelector(`[data-target-input="${input.id}"]`);
                if (fkSearch) {
                    input.addEventListener('change', function() {
                        if (this.value) {
                            loadForeignKeyDisplay(fkSearch, this.value);
                        } else {
                            const selectedDisplay = fkSearch.parentElement.querySelector('.fk-selected-display,.junction-fk-selected-display');
                            selectedDisplay.style.display = 'none';
                            fkSearch.style.display = 'block';
                        }
                    });
                    
                    input.addEventListener('input', function() {
                        // Clear the display when manually typing
                        const selectedDisplay = fkSearch.parentElement.querySelector('.fk-selected-display,.junction-fk-selected-display');
                        if (selectedDisplay.style.display === 'block') {
                            selectedDisplay.style.display = 'none';
                            fkSearch.style.display = 'block';
                        }
                    });
                }
            });
        });
        
        function handleForeignKeySearch(input) {
            const query = input.value.trim();
            const resultsDiv = input.parentElement.querySelector('.fk-search-results');
            const inputId = input.dataset.targetInput;
            
            // Clear previous timeout
            if (fkSearchTimeouts[inputId]) {
                clearTimeout(fkSearchTimeouts[inputId]);
            }
            
            if (query.length < 1) {
                resultsDiv.style.display = 'none';
                return;
            }
            
            // Debounce the search
            fkSearchTimeouts[inputId] = setTimeout(() => {
                searchForeignKey(input, query);
            }, 300);
        }
        
        async function searchForeignKey(input, query) {
            const resultsDiv = input.parentElement.querySelector('.fk-search-results');
            const table = input.dataset.table;
            const searchColumns = input.dataset.searchColumns;
            
            try {
                resultsDiv.innerHTML = '<div class="fk-search-result">Searching...</div>';
                resultsDiv.style.display = 'block';
                
                const response = await fetch(`/search_foreign_key/${table}?q=${encodeURIComponent(query)}&columns=${encodeURIComponent(searchColumns)}`);
                const data = await response.json();
                
                if (data.results && data.results.length > 0) {
                    resultsDiv.innerHTML = '';
                    data.results.forEach(result => {
                        const resultDiv = document.createElement('div');
                        resultDiv.className = 'fk-search-result';
                        resultDiv.innerHTML = result.display;
                        resultDiv.onclick = () => selectForeignKey(input, result.id, result.display);
                        resultsDiv.appendChild(resultDiv);
                    });
                } else {
                    resultsDiv.innerHTML = '<div class="fk-search-result">No results found</div>';
                }
            } catch (error) {
                console.error('Search error:', error);
                resultsDiv.innerHTML = '<div class="fk-search-result">Search failed</div>';
            }
        }
        
        function selectForeignKey(searchInput, id, display) {
            const targetInput = document.getElementById(searchInput.dataset.targetInput);
            const selectedDisplay = searchInput.parentElement.querySelector('.fk-selected-display');
            const resultsDiv = searchInput.parentElement.querySelector('.fk-search-results');
            
            if (!targetInput || !selectedDisplay || !resultsDiv) {
                console.error('Required elements not found for FK selection');
                return;
            }
            
            // Set the ID in the hidden input
            targetInput.value = id;
            
            // Update the display
            selectedDisplay.innerHTML = `Selected: ${display} (ID: ${id})`;
            selectedDisplay.style.display = 'block';
            
            // Hide search input and results
            searchInput.style.display = 'none';
            resultsDiv.style.display = 'none';
        }
        
        function showForeignKeySearch(displayElement) {
            const container = displayElement.parentElement;
            const searchInput = container.querySelector('.fk-search-input');
            
            if (!searchInput) {
                console.error('FK search input not found');
                return;
            }
            
            // Show search input and focus it
            searchInput.style.display = 'block';
            searchInput.focus();
            searchInput.select();
            
            // Hide display element temporarily
            displayElement.style.display = 'none';
        }
        
        async function loadForeignKeyDisplay(searchInput, id) {
            const table = searchInput.dataset.table;
            const selectedDisplay = searchInput.parentElement.querySelector('.fk-selected-display,.junction-fk-selected-display');
            
            if (!id) return;
            
            try {
                const response = await fetch(`/get_foreign_key_display/${table}/${id}`);
                const data = await response.json();
                
                if (data.success) {
                    selectedDisplay.innerHTML = `Selected: ${data.display} (ID: ${id})`;
                    selectedDisplay.style.display = 'block';
                    searchInput.style.display = 'none';
                    const addButton = document.getElementById(`add-junction-${searchInput.dataset.junctionName}-btn`);
                    console.log(addButton);
                    if (addButton) {
                        addButton.disabled = false;
                    }
                }
            } catch (error) {
                console.error('Error loading FK display:', error);
            }
        }

        // Junction FK Search functionality
        function handleJunctionForeignKeySearch(input) {
            console.log('handleJunctionForeignKeySearch called with:', input.value);
            const query = input.value.trim();
            const resultsDiv = input.parentElement.querySelector('.junction-fk-search-results');
            const inputId = input.dataset.targetInput;
            
            console.log('Search query:', query);
            console.log('Results div found:', !!resultsDiv);
            
            // Clear previous timeout
            if (junctionFkSearchTimeouts[inputId]) {
                clearTimeout(junctionFkSearchTimeouts[inputId]);
            }
            
            if (query.length < 1) {
                if (resultsDiv) {
                    resultsDiv.style.display = 'none';
                }
                const addButton = document.getElementById(`add-junction-${input.dataset.junctionName}-btn`);
                console.log(addButton)
                if (addButton) {
                    addButton.disabled = true;
                }
                return;
            }
            
            // Debounce the search
            junctionFkSearchTimeouts[inputId] = setTimeout(() => {
                console.log('Executing search after debounce...');
                searchJunctionForeignKey(input, query);
            }, 300);
        }
        
        async function searchJunctionForeignKey(input, query) {
            const resultsDiv = input.parentElement.querySelector('.junction-fk-search-results');
            const table = input.dataset.table;
            const junctionName = input.dataset.junctionName;
            const mainId = input.dataset.mainId;
            
            // Get search columns from the input data attributes or use defaults
            const searchColumns = input.dataset.searchColumns || getJunctionSearchColumns(table);
            
            try {
                resultsDiv.innerHTML = '<div class="junction-fk-search-result">Searching...</div>';
                resultsDiv.style.display = 'block';
                
                const response = await fetch(`/search_foreign_key/${table}?q=${encodeURIComponent(query)}&columns=${encodeURIComponent(searchColumns)}`);
                const data = await response.json();
                
                if (data.results && data.results.length > 0) {
                    resultsDiv.innerHTML = '';
                    
                    // Check each result for existing relationships
                    for (const result of data.results) {
                        const alreadyLinked = await checkIfAlreadyLinked(table, mainId, result.id, junctionName);
                        
                        const resultDiv = document.createElement('div');
                        resultDiv.className = 'junction-fk-search-result';
                        
                        if (alreadyLinked) {
                            resultDiv.innerHTML = `${result.display} <em style="color: #ffc107;">(Already linked)</em>`;
                            resultDiv.style.backgroundColor = '#fff3cd';
                            resultDiv.style.cursor = 'not-allowed';
                        } else {
                            resultDiv.innerHTML = result.display;
                            resultDiv.onclick = () => selectJunctionForeignKey(input, result.id, result.display);
                        }
                        resultsDiv.appendChild(resultDiv);
                    }
                } else {
                    resultsDiv.innerHTML = '<div class="junction-fk-search-result">No results found</div>';
                }
            } catch (error) {
                console.error('Search error:', error);
                resultsDiv.innerHTML = '<div class="junction-fk-search-result">Search failed</div>';
            }
        }
        
        function selectJunctionForeignKey(searchInput, id, display) {
            const targetInput = document.getElementById(searchInput.dataset.targetInput);
            const selectedDisplay = searchInput.parentElement.querySelector('.junction-fk-selected-display');
            const resultsDiv = searchInput.parentElement.querySelector('.junction-fk-search-results');
            const addButton = document.getElementById(`add-junction-${searchInput.dataset.junctionName}-btn`);
            
            if (!targetInput || !selectedDisplay || !resultsDiv) {
                console.error('Required elements not found for junction FK selection');
                return;
            }
            
            // Set the ID in the hidden input
            targetInput.value = id;
            
            // Update the display
            selectedDisplay.innerHTML = `Selected: ${display} (ID: ${id})`;
            selectedDisplay.style.display = 'block';
            
            // Hide search input and results
            searchInput.style.display = 'none';
            resultsDiv.style.display = 'none';
            
            // Enable the add button
            if (addButton) {
                addButton.disabled = false;
            }
        }
        
        function showJunctionForeignKeySearch(displayElement) {
            const container = displayElement.parentElement;
            const searchInput = container.querySelector('.junction-fk-search-input');
            
            if (!searchInput) {
                console.error('Junction FK search input not found');
                return;
            }
            
            const addButton = document.getElementById(`add-junction-${searchInput.dataset.junctionName}-btn`);
            
            // Show search input and focus it
            searchInput.style.display = 'block';
            searchInput.focus();
            searchInput.select();
            
            // Hide display element temporarily and disable button
            displayElement.style.display = 'none';
            if (addButton) {
                addButton.disabled = true;
            }
        }
        
        
        async function checkIfAlreadyLinked(tableName, mainId, otherId, junctionName) {
            try {
                const response = await fetch(`/verify_junction_id/${tableName}/${mainId}/${otherId}`, {
                    method: 'GET',
                });
                
                const data = await response.json();
                return data.already_linked || false;
            } catch (error) {
                console.error('Error checking if already linked:', error);
                return false;
            }
        }
        
        function getJunctionSearchColumns(table) {
            // This would ideally come from the server, but for now we'll use common defaults
            // You might want to pass this data from the template or make it configurable
            const commonColumns = {
                'users': 'username,email',
                'groups': 'name,description',
                'databank': 'topic,title'
            };
            
            return commonColumns[table] || 'name,title,description';
        }

        // Junction table row editing
        function editJunctionRow(rowIndex, junctionName) {
            const row = document.getElementById(`junction-row-${rowIndex}`);
            const displayValues = row.querySelectorAll('.display-value');
            const editValues = row.querySelectorAll('.edit-value');
            const editBtn = row.querySelector('.edit-btn');
            const saveBtn = row.querySelector('.save-btn');
            const cancelBtn = row.querySelector('.cancel-btn');
            
            // Show edit inputs, hide display values
            displayValues.forEach(el => el.style.display = 'none');
            editValues.forEach(el => el.style.display = 'block');
            
            // Show save/cancel buttons, hide edit button
            editBtn.style.display = 'none';
            saveBtn.style.display = 'inline-block';
            cancelBtn.style.display = 'inline-block';
            
            // Add visual indicator
            row.classList.add('editable-row');
        }
        
        function cancelJunctionEdit(rowIndex) {
            const row = document.getElementById(`junction-row-${rowIndex}`);
            const displayValues = row.querySelectorAll('.display-value');
            const editValues = row.querySelectorAll('.edit-value');
            const editBtn = row.querySelector('.edit-btn');
            const saveBtn = row.querySelector('.save-btn');
            const cancelBtn = row.querySelector('.cancel-btn');
            
            // Restore original values
            editValues.forEach((input, index) => {
                input.value = displayValues[index].textContent;
            });
            
            // Show display values, hide edit inputs
            displayValues.forEach(el => el.style.display = 'block');
            editValues.forEach(el => el.style.display = 'none');
            
            // Show edit button, hide save/cancel buttons
            editBtn.style.display = 'inline-block';
            saveBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
            
            // Remove visual indicator
            row.classList.remove('editable-row');
        }
        
        async function saveJunctionRow(rowIndex, junctionName) {
            const row = document.getElementById(`junction-row-${rowIndex}`);
            const editValues = row.querySelectorAll('.edit-value');
            
            // Collect form data
            const formData = new FormData();
            formData.append('junction_name', junctionName);
            
            // Add original primary key values for WHERE clause
            row.querySelectorAll('input[type="hidden"]').forEach(input => {
                formData.append(`original_${input.name}`, input.value);
            });
            
            // Add updated extra column values
            editValues.forEach(input => {
                const columnName = input.closest('td').getAttribute('data-column');
                if (columnName) {
                    formData.append(`extra_${columnName}`, input.value);
                }
            });
            
            try {
                const response = await fetch(`/{{ table_name }}/update_junction_entry`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    // Update display values
                    const displayValues = row.querySelectorAll('.display-value');
                    editValues.forEach((input, index) => {
                        displayValues[index].textContent = input.value;
                    });
                    
                    // Switch back to display mode
                    cancelJunctionEdit(rowIndex);
                } else {
                    alert('Failed to update junction entry');
                }
            } catch (error) {
                console.error('Save error:', error);
                alert('Error saving changes');
            }
        }

        // Initialize junction FK search inputs
        document.querySelectorAll('.junction-fk-search-input').forEach(input => {
            const targetInput = document.getElementById(input.dataset.targetInput);
            
            input.addEventListener('input', function() {
                handleJunctionForeignKeySearch(this);
            });
            
            input.addEventListener('focus', function() {
                if (this.value.length >= 1) {
                    handleJunctionForeignKeySearch(this);
                }
            });
            
            input.addEventListener('blur', function() {
                // Delay hiding results
                setTimeout(() => {
                    const results = this.parentElement.querySelector('.junction-fk-search-results');
                    results.style.display = 'none';
                }, 200);
            })
        })
    </script>
</body>
</html> 